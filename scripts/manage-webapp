#!/bin/bash

# manage-webapp - Interactive script to install or uninstall web applications

ICON_DIR="$HOME/.local/share/applications/icons"
DESKTOP_DIR="$HOME/.local/share/applications"
mkdir -p "$ICON_DIR"

DEFAULT_BROWSER=$(xdg-settings get default-web-browser)
if [[ "$DEFAULT_BROWSER" == *"chrome"* ]]; then
  BROWSER="chrome"
elif [[ "$DEFAULT_BROWSER" == *"brave"* ]]; then
  BROWSER="brave"
fi

PROFILE_NAME="Profile_4"

if ! command -v gum &> /dev/null; then
  echo "Error: 'gum' is not installed. Please install it first."
  exit 1
fi

ACTION=$1

# If no action provided, ask interactively
if [[ -z "$ACTION" ]]; then
  ACTION=$(gum choose "Install" "Uninstall" "Exit")
fi

case "$ACTION" in
  Install|install)
    # Check if we have enough arguments for non-interactive mode
    if [ "$#" -lt 4 ]; then
      echo -e "\e[32mLet's create a new web app you can start with the app launcher.\n\e[0m"
      APP_NAME=$(gum input --prompt "Name> " --placeholder "My favorite web app")
      APP_URL=$(gum input --prompt "URL> " --placeholder "https://example.com")
      ICON_REF=$(gum input --prompt "Icon URL> " --placeholder "See https://dashboardicons.com (must use PNG!)")
      CUSTOM_EXEC=""
      MIME_TYPES=""
      INTERACTIVE_MODE=true
    else
      APP_NAME="$2"
      APP_URL="$3"
      ICON_REF="$4"
      CUSTOM_EXEC="$5"
      MIME_TYPES="$6"
      INTERACTIVE_MODE=false
    fi

    if [[ -z "$APP_NAME" || -z "$APP_URL" || -z "$ICON_REF" ]]; then
      echo "Error: App name, URL, and Icon reference are required."
      exit 1
    fi

    # Handle Icon
    if [[ $ICON_REF =~ ^https?:// ]]; then
      ICON_PATH="$ICON_DIR/$APP_NAME.png"
      if ! curl -sL -o "$ICON_PATH" "$ICON_REF"; then
        echo "Error: Failed to download icon from $ICON_REF"
        exit 1
      fi
    else
      # Assume it's a file name in the icon dir or a path
      if [[ -f "$ICON_REF" ]]; then
        ICON_PATH="$ICON_REF"
      else
        ICON_PATH="$ICON_DIR/$ICON_REF"
      fi
    fi

    # Determine execution command
    if [[ -n $CUSTOM_EXEC ]]; then
      EXEC_COMMAND="$CUSTOM_EXEC"
    else
      EXEC_COMMAND="launch-webapp $APP_URL"
    fi

    # Extract domain from URL for StartupWMClass
    URL_DOMAIN=$(echo "$APP_URL" | sed -r 's/https?:\/\///; s/\/.*//; s/:.*//')
    WM_CLASS="${BROWSER}-${URL_DOMAIN}__-${PROFILE_NAME}"

    # Create application .desktop file
    DESKTOP_FILE="$DESKTOP_DIR/$APP_NAME.desktop"

    cat >"$DESKTOP_FILE" <<EOF
[Desktop Entry]
Version=1.0
Name=$APP_NAME
Comment=$APP_NAME
Exec=$EXEC_COMMAND
Terminal=false
Type=Application
Icon=$ICON_PATH
StartupNotify=true
StartupWMClass=$WM_CLASS
EOF

    # Add mime types if provided
    if [[ -n $MIME_TYPES ]]; then
      echo "MimeType=$MIME_TYPES" >>"$DESKTOP_FILE"
    fi

    chmod +x "$DESKTOP_FILE"

    if [[ $INTERACTIVE_MODE == true ]]; then
      echo -e "\nSuccess! You can now find '$APP_NAME' in your app launcher."
    fi
    ;;

  Uninstall|uninstall)
    WEB_APPS=()
    # Find all desktop files that use launch-webapp
    while IFS= read -r -d '' file; do
      if grep -q 'launch-webapp' "$file"; then
        WEB_APPS+=("$(basename "${file%.desktop}")")
      fi
    done < <(find "$DESKTOP_DIR" -name '*.desktop' -print0)

    if ((${#WEB_APPS[@]})); then
      IFS=$'\n' SORTED_WEB_APPS=($(sort <<<"${WEB_APPS[*]}"))
      unset IFS
      
      if [[ -z "$2" ]]; then
        APP_NAMES_STRING=$(gum choose --no-limit --header "Select web apps to remove..." --selected-prefix="âœ— " "${SORTED_WEB_APPS[@]}")
        APP_NAMES=()
        while IFS= read -r line; do
          [[ -n "$line" ]] && APP_NAMES+=("$line")
        done <<< "$APP_NAMES_STRING"
      else
        shift
        APP_NAMES=("$@")
      fi
    else
      echo "No web apps found to remove."
      exit 0
    fi

    if [[ ${#APP_NAMES[@]} -eq 0 ]]; then
      echo "No apps selected for removal."
      exit 0
    fi

    for APP_NAME in "${APP_NAMES[@]}"; do
      rm -f "$DESKTOP_DIR/$APP_NAME.desktop"
      # Also try to remove the icon if it was downloaded
      rm -f "$ICON_DIR/$APP_NAME.png"
      echo "Removed: $APP_NAME"
    done
    ;;

  Exit|exit)
    exit 0
    ;;

  *)
    echo "Usage: manage-webapp [install|uninstall] [args...]"
    echo "  install <name> <url> <icon_url_or_path> [custom_exec] [mime_types]"
    echo "  uninstall [name1] [name2] ..."
    exit 1
    ;;
esac
